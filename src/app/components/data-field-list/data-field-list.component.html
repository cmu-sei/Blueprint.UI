<!--
Copyright 2022 Carnegie Mellon University. All Rights Reserved.
Released under a MIT (SEI)-style license, please see LICENSE.md in the
project root for license information or contact permission@sei.cmu.edu for full terms.
-->
<div *ngIf="msel" style="height: 100%;">

  <div style="height: 100%">
    <section
      matSort
      (matSortChange)="sortChanged($event)"
      class="mat-elevation-z2 mat-header-row background-alt"
    >
      <span class="mat-header-cell one-cell" mat-sort-header="displayOrder">
        <button
          mat-icon-button
          (click)="addDataField(); $event.stopPropagation()"
          style="outline: none; margin-right: 15px;"
          title="Add new data field"
          [disabled]="isAddingDataField || valuesHaveBeenChanged()"
          *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
        >
          <mat-icon class="mdi-24px self-center" fontIcon="mdi-plus-circle-outline"></mat-icon>
        </button>
        Order
      </span>
      <span class="mat-header-cell one-cell">Display On<br />Injects&nbsp;&nbsp;&nbsp;&nbsp;Exercise View</span>
      <span class="mat-header-cell two-cell" mat-sort-header="name">Name</span>
      <span class="mat-header-cell two-cell" mat-sort-header="dataType">Data Type</span>
      <span class="mat-header-cell one-cell" mat-sort-header="isChosenFromList">Options</span>
      <span class="mat-header-cell one-cell search-cell">
        <mat-form-field class="search-control">
          <input matInput [formControl]="filterControl" placeholder="Search" />
        </mat-form-field>
        <div style="width: 30px;">
          <button
            mat-icon-button
            (click)="filterControl.setValue(''); $event.stopPropagation()"
            style="outline: none;"
            title="Clear Search"
            [disabled]="!filterString"
          >
            <mat-icon class="mdi-24px self-center" fontIcon="mdi-close-circle-outline"></mat-icon>
          </button>
        </div>
      </span>
    </section>

    <section class="scrolling-region">
      <!-- new data field -->
      <mat-expansion-panel *ngIf="isAddingDataField" expanded="true">
        <mat-expansion-panel-header
          class="mat-row"
          (click)="$event.stopPropagation();"
        >
          <div class="mat-cell flex-row-cell five-cell" (click)="$event.stopPropagation();">
            <span class="edit-buttons">
              <button
                mat-icon-button
                (click)="saveNewDataField(); $event.stopPropagation()"
                style="outline: none;"
                title="Save new data field"
              >
                <mat-icon class="mdi-24px self-center" fontIcon="mdi-check"></mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="cancelNewDataField(); $event.stopPropagation()"
                style="outline: none;"
                title="Cancel new data field"
              >
                <mat-icon class="mdi-24px self-center" fontIcon="mdi-close"></mat-icon>
              </button>
            </span>
            <b>Creating New Data Field</b>
          </div>
          <div class="mat-cell flex-row-cell five-cell">&nbsp;</div>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Display Order"
                  [(ngModel)]="changedDataField.displayOrder"
                />
              </mat-form-field>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Name"
                  [(ngModel)]="changedDataField.name"
                />
              </mat-form-field>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <mat-select placeholder="Data Type" [(ngModel)]="changedDataField.dataType" [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner">
                  <mat-option value="String">String</mat-option>
                  <mat-option value="Integer">Integer</mat-option>
                  <mat-option value="Double">Double</mat-option>
                  <mat-option value="Boolean">Boolean</mat-option>
                  <mat-option value="DateTime">DateTime</mat-option>
                  <mat-option value="Organization">Organization</mat-option>
                  <mat-option value="Html">Html</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.isChosenFromList" class="bottom-margin">Selected From a List?</mat-checkbox><br />
              <span *ngIf="changedDataField.isChosenFromList">
                <input
                  *ngFor="let dataOption of changedDataField.dataOptions"
                  type="text"
                  matInput
                  placeholder="Options"
                  [(ngModel)]="dataOption.optionValue"
                />
                <button
                  mat-icon-button
                  (click)="addDataOption(changedDataField)"
                  style="outline: none; margin-right: 15px;"
                  title="Add new data option"
                >
                  <mat-icon class="mdi-24px self-center" fontIcon="mdi-plus-circle-outline"></mat-icon>
                </button>
              </span>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.isInitiallyHidden" class="bottom-margin">Hidden under "More Fields" section</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.isOnlyShownToOwners" class="bottom-margin">ONLY Display for Content Developers and Owners</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.onScenarioEventList" class="bottom-margin">Display in header of Injects</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.onExerciseView" class="bottom-margin">Display in header of Exercise View</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <mat-select placeholder="Gallery Article Parameter" [(ngModel)]="changedDataField.galleryArticleParameter" [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner">
                  <mat-option value=""></mat-option>
                  <mat-option *ngFor="let parameter of msel.galleryArticleParameters" value="{{ parameter }}">{{ parameter }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div
            class="data-field-detail"
            (click)="$event.stopPropagation();"
            *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
          >
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Column Metadata (Width)"
                  [(ngModel)]="changedDataField.columnMetadata"
                />
              </mat-form-field>
            </div>
          </div>
          <div
            class="data-field-detail"
            (click)="$event.stopPropagation();"
            *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
          >
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Cell Metadata (Color, Tint, Font-Weight)"
                  [(ngModel)]="changedDataField.cellMetadata"
                />
              </mat-form-field>
            </div>
          </div>
        </ng-template>
      </mat-expansion-panel>


      <!-- existing data fields -->
      <mat-expansion-panel
        *ngFor="let item of sortedDataFields;"
        [expanded]="editingId === item.id"
        [disabled]="noExpansionChangeAllowed()"
      >
        <mat-expansion-panel-header
          class="mat-row"
          (click)="editDataField(item); $event.stopPropagation();"
        >
          <div class="mat-cell flex-row-cell one-cell">
            <button
              mat-icon-button
              class="data-field-button"
              title="Edit this data field"
              *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
            >
              <mat-icon class="mdi-18px up-12" fontIcon="mdi-square-edit-outline"></mat-icon>
            </button>
            <button
              mat-icon-button
              class="data-field-button"
              (click)="deleteDataField(item); $event.stopPropagation()"
              title="Delete this data field"
              *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
            >
              <mat-icon class="mdi-18px up-12" fontIcon="mdi-delete"></mat-icon>
            </button>
            &nbsp;{{ item.displayOrder }}
          </div>
          <div class="mat-cell flex-row-cell one-cell center-self">
            <mat-checkbox
              [(ngModel)]="item.onScenarioEventList"
              [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner"
              (change)="saveChange(item);"
              (click)="$event.stopPropagation();"
            >
            </mat-checkbox>
            <mat-checkbox
              [(ngModel)]="item.onExerciseView"
              [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner"
              (change)="saveChange(item);"
              (click)="$event.stopPropagation();"
              class="exercise-view-checkbox"
            >
            </mat-checkbox>
          </div>
          <div class="mat-cell two-cell center-self">{{ item.name }}</div>
          <div class="mat-cell two-cell center-self">{{ item.dataType }}</div>
          <div class="mat-cell two-cell center-self">
            {{ item.dataOptions }}
          </div>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <div *ngIf="valuesHaveBeenChanged()" (click)="$event.stopPropagation();">
            <span class="edit-buttons">
              <button
                mat-icon-button
                (click)="saveDataField();"
                style="outline: none;"
                title="Save new data field"
              >
                <mat-icon class="mdi-24px self-center" fontIcon="mdi-check"></mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="resetDataField();"
                style="outline: none;"
                title="Cancel new data field"
              >
                <mat-icon class="mdi-24px self-center" fontIcon="mdi-close"></mat-icon>
              </button>
            </span>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Display Order"
                  [(ngModel)]="changedDataField.displayOrder"
                  [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner"
                />
              </mat-form-field>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <mat-label>Name</mat-label>
                <input
                  type="text"
                  matInput
                  [(ngModel)]="changedDataField.name"
                  [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner"
                />
              </mat-form-field>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <mat-select placeholder="Data Type" [(ngModel)]="changedDataField.dataType" [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner">
                  <mat-option *ngFor="let dataFieldType of dataFieldTypes" value="{{ dataFieldType }}">{{ dataFieldType }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <div class="partial-detail">
                <mat-checkbox
                  [(ngModel)]="changedDataField.isChosenFromList"
                  [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner"
                  class="bottom-margin"
                >
                  Use Option List
                </mat-checkbox><br />
              </div>
              <div class="data-options" *ngIf="changedDataField.isChosenFromList">
                <div class="data-option" *ngFor="let dataOption of getDataFieldOptions(changedDataField.id)">
                  <div *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner">
                    <button
                      mat-icon-button
                      class="data-field-button"
                      (click)="editDataOption(dataOption); $event.stopPropagation()"
                      title="Edit this option"
                    >
                      <mat-icon class="mdi-18px up-12" fontIcon="mdi-square-edit-outline"></mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      class="data-field-button"
                      (click)="deleteDataOption(dataOption); $event.stopPropagation()"
                      title="Delete this option"
                    >
                      <mat-icon class="mdi-18px up-12" fontIcon="mdi-delete"></mat-icon>
                    </button>
                  </div>
                  <div class="center-self">
                    &nbsp;{{ dataOption.displayOrder }} &nbsp;&nbsp; {{dataOption.optionName }} &nbsp;&nbsp; {{dataOption.optionValue }}
                  </div>
                </div>
                <div class="data-option" *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner">
                  <button
                    mat-icon-button
                    (click)="addDataOption(changedDataField)"
                    style="outline: none; margin-right: 15px;"
                    title="Add new data option"
                  >
                    <mat-icon class="mdi-24px self-center" fontIcon="mdi-plus-circle-outline"></mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.isInitiallyHidden" class="bottom-margin">Hidden under "More Fields" section</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.isOnlyShownToOwners" class="bottom-margin">ONLY Display for Content Developers and Owners</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.onScenarioEventList" class="bottom-margin">Display in header of Injects</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();">
            <div class="single-detail">
              <mat-checkbox [(ngModel)]="changedDataField.onExerciseView" class="bottom-margin">Display in header of Exercise View</mat-checkbox><br />
            </div>
          </div>
          <div class="data-field-detail" (click)="$event.stopPropagation();" *ngIf="msel.useGallery">
            <div class="single-detail">
              <mat-form-field class="full-width">
                <mat-select placeholder="Gallery Article Parameter" [(ngModel)]="changedDataField.galleryArticleParameter" [disabled]="!isContentDeveloper && !msel.hasRole(loggedInUserId, null).owner">
                  <mat-option value=""></mat-option>
                  <mat-option *ngFor="let parameter of msel.galleryArticleParameters" value="{{ parameter }}">{{ parameter }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div
            class="data-field-detail"
            (click)="$event.stopPropagation();"
            *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
          >
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Column Metadata (Width)"
                  [(ngModel)]="changedDataField.columnMetadata"
                />
              </mat-form-field>
            </div>
          </div>
          <div
            class="data-field-detail"
            (click)="$event.stopPropagation();"
            *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, null).owner"
          >
            <div class="single-detail">
              <mat-form-field class="full-width">
                <input
                  type="text"
                  matInput
                  placeholder="Cell Metadata (Color, Tint, Font-Weight)"
                  [(ngModel)]="changedDataField.cellMetadata"
                />
              </mat-form-field>
            </div>
          </div>
        </ng-template>
      </mat-expansion-panel>
    </section>
  </div>
</div>
