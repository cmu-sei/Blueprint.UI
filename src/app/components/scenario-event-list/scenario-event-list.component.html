<!--
Copyright 2022 Carnegie Mellon University. All Rights Reserved.
Released under a MIT (SEI)-style license, please see LICENSE.md in the
project root for license information or contact permission@sei.cmu.edu for full terms.
-->
<div class="container">
  <div class="tableFixHead" *ngIf="msel">
    <table>
      <thead matSort
      (matSortChange)="sortChanged($event)">
        <tr>
          <th class="background">
            <div class="header-row-start">
              <mat-form-field *ngIf="showSearch">
                <input
                  matInput
                  [(ngModel)]="filterString"
                  (keyup)="keyUp.next($event)"
                  placeholder="Search"
                  style="font-size: 10pt;"
                  *ngIf="showSearch"
                />
              </mat-form-field>
              <div class="header-buttons">
                <button
                  mat-icon-button
                  (click)="addScenarioEvent()"
                  style="outline: none;"
                  title="Add new event"
                  *ngIf="(isContentDeveloper || msel.hasRole(loggedInUserId, null).owner) && selectedEventIdList.length === 0"
                >
                  <mat-icon class="mdi-24px" fontIcon="mdi-plus-circle-outline"></mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="batchDeleteScenarioEvents()"
                  style="outline: none;"
                  title="Delete selected events"
                  *ngIf="(isContentDeveloper || msel.hasRole(loggedInUserId, null).owner) && selectedEventIdList.length > 0"
                >
                  <mat-icon class="mdi-24px" fontIcon="mdi-delete"></mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="setSearch(true)"
                  style="outline: none;"
                  title="Search Events"
                  *ngIf="!showSearch"
                >
                  <mat-icon class="mdi-24px" fontIcon="mdi-filter-outline"></mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="setSearch(false)"
                  style="outline: none;"
                  title="Clear Search"
                  *ngIf="showSearch"
                >
                  <mat-icon class="mdi-24px" fontIcon="mdi-filter-off-outline"></mat-icon>
                </button>
              </div>
            </div>
          </th>
          <ng-container *ngFor="let df of sortedDataFields">
            <th mat-sort-header="{{ df.name }}" class="background">
              <div [style]="getStyle(df)">{{ df.name }}</div>
            </th>
          </ng-container>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let item of sortedScenarioEvents">
          <tr [style]="getRowStyle(item)">
            <td class="">
              <div class="row-start-buttons">
                <mat-checkbox
                  [checked]="getSelectedState(item.id)"
                  (change)="setSelectedState(item.id, $event.checked)"
                  title="Select event {{ item.rowIndex }}"
                ></mat-checkbox>
                <button
                  mat-icon-button
                  class="scenario-event-button"
                  [matMenuTriggerFor]="actionList"
                  (click)="$event.stopPropagation()"
                  title="Action List"
                  [disabled]="selectedEventIdList.length > 0"
                >
                  <mat-icon class="mdi-24px up-12" fontIcon="mdi-menu-down"></mat-icon>
                </button>
                <mat-menu #actionList="matMenu" [overlapTrigger]="false">
                  <button
                    mat-menu-item
                    (click)="editScenarioEvent(item)"
                    title="Edit event {{ item.rowIndex }}"
                  >
                    Edit
                  </button>
                  <button
                    mat-menu-item
                    [matMenuTriggerFor]="colorList"
                    (click)="$event.stopPropagation()"
                    title="Highlight event {{ item.rowIndex }}"
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                  >
                    Highlight
                  </button>
                  <mat-menu #colorList="matMenu" [overlapTrigger]="false">
                    <button
                      mat-menu-item
                      (click)="selectNewColor('', item)"
                      class="color-option-button"
                    >
                      <div class="color-option" [style]="getStyleFromColor('')"></div>
                    </button>
                    <button
                      mat-menu-item
                      *ngFor="let color of scenarioEventBackgroundColors"
                      (click)="selectNewColor(color, item)"
                      class="color-option-button"
                    >
                      <div class="color-option" [style]="getStyleFromColor(color)">&nbsp;</div>
                    </button>
                  </mat-menu>
                  <button
                    mat-menu-item
                    (click)="copyScenarioEvent(item)"
                    title="Copy"
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                  >
                    Copy
                  </button>
                  <button
                    mat-menu-item
                    (click)="deleteScenarioEvent(item)"
                    title="Delete event {{ item.rowIndex }}"
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                  >
                    Delete
                  </button>
                </mat-menu>
                <span class="row-index center-self">{{ item.rowIndex }}</span>
              </div>
            </td>
            <ng-container *ngFor="let df of sortedDataFields">
              <!-- HTML value -->
              <td *ngIf="df.dataType.toString() === 'Html'">
                <div class="html-constrainer" [style]="getStyle(df)">
                  <quill-view-html [content]="getScenarioEventValue(item, df.name)" theme="snow"></quill-view-html>
                </div>
              </td>
              <!-- Organization value -->
              <td *ngIf="df.dataType.toString() === 'Organization'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).editor"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="None"
                    [(ngModel)]="getDataValue(item, df.name).value"
                  >
                    <mat-option value="None">None</mat-option>
                    <mat-option *ngFor="let org of getSortedOrganizationOptions()" [value]="org">
                      {{ org }}
                    </mat-option>
                  </mat-select>
                  <span *ngIf="!isContentDeveloper && !msel.hasRole(loggedInUserId, item.id).editor">{{ getDataValue(item, df.name).value }}</span>
                </div>
              </td>
              <!-- TeamsMultiple value -->
              <td *ngIf="df.dataType.toString() === 'TeamsMultiple'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    multiple
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).editor"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValueArray(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="None"
                    [value]="getDataValue(item, df.name).valueArray"
                  >
                  <mat-option value="None">None</mat-option>
                  <mat-option value="ALL">ALL</mat-option>
                  <mat-option *ngFor="let org of getSortedTeamOptions()" [value]="org">
                      {{ org }}
                    </mat-option>
                  </mat-select>
                  <span *ngIf="!isContentDeveloper && !msel.hasRole(loggedInUserId, item.id).editor">{{ getDataValue(item, df.name).value }}</span>
                </div>
              </td>
              <!-- Status value -->
              <td *ngIf="df.dataType.toString() === 'Status'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).approver"
                    [(ngModel)]="getDataValue(item, df.name).value"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="None"
                  >
                    <mat-option *ngFor="let status of itemStatus" [value]="status">
                      {{ status }}
                    </mat-option>
                  </mat-select>
                  <span *ngIf="!isContentDeveloper && !msel.hasRole(loggedInUserId, item.id).approver">{{ getDataValue(item, df.name).value }}</span>
                </div>
              </td>
              <!-- Assigned Team value -->
              <td *ngIf="df.dataType.toString() === 'Team'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                    [(ngModel)]="getDataValue(item, df.name).value"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="None"
                  >
                    <mat-option *ngFor="let team of teamList" [value]="team.shortName">
                      {{ team.shortName }}
                    </mat-option>
                  </mat-select>
                  <span *ngIf="!isContentDeveloper && !msel.hasRole(loggedInUserId, item.id).owner">{{ getDataValue(item, df.name).value }}</span>
                </div>
              </td>
              <!-- datetime value -->
              <td *ngIf="df.dataType.toString() === 'DateTime'">
                <div class="constrainer" [style]="getStyle(df)">
                  {{ getScenarioEventDateValue(item, df.name) }}
                </div>
              </td>
              <!-- User value -->
              <td *ngIf="df.dataType.toString() === 'User'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                    [(ngModel)]="getDataValue(item, df.name).value"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="None"
                  >
                    <mat-option *ngFor="let user of mselUsers" [value]="user.id">
                      {{ user.name }}
                    </mat-option>
                  </mat-select>
                  <span *ngIf="!isContentDeveloper && !msel.hasRole(loggedInUserId, item.id).owner">{{ getDataValue(item, df.name).value }}</span>
                </div>
              </td>
              <!-- checkbox value -->
              <td *ngIf="df.dataType.toString() === 'Checkbox'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-checkbox
                    [checked]="getDataValue(item, df.name).value"
                    (change)="saveDataValue(item, df.name, $event.checked.toString())"
                  ></mat-checkbox>
                </div>
              </td>
              <!-- Card value -->
              <td *ngIf="df.dataType.toString() === 'Card'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                    [(ngModel)]="getDataValue(item, df.name).value"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="Gallery Card"
                  >
                    <mat-option value="''"> - - - </mat-option>
                    <mat-option *ngFor="let card of cardList" [value]="card.id">{{ card.name }}</mat-option>
                  </mat-select>
                </div>
              </td>
              <!-- Move value -->
              <td *ngIf="df.dataType.toString() === 'Move'">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).owner"
                    [(ngModel)]="getDataValue(item, df.name).value"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder="Move"
                  >
                    <mat-option value="''"> - - - </mat-option>
                    <mat-option *ngFor="let move of moveList" [value]="move.moveNumber">{{ move.moveNumber }} - {{ move.title }}</mat-option>
                  </mat-select>
                </div>
              </td>
              <!-- is Chosen From a List -->
              <td *ngIf="df.isChosenFromList">
                <div class="constrainer" [style]="getStyle(df)">
                  <mat-select
                    *ngIf="isContentDeveloper || msel.hasRole(loggedInUserId, item.id).editor"
                    [(ngModel)]="getDataValue(item, df.name).value"
                    (click)="$event.stopPropagation()"
                    (valueChange)="saveDataValue(item, df.name, $event)"
                    class="header-dropdown"
                    placeholder=" - - - "
                  >
                    <mat-option value=""> - - - </mat-option>
                    <mat-option *ngFor="let dataOption of getDataOptions(df.id)" [value]="dataOption.optionValue">{{ dataOption.optionName }}</mat-option>
                  </mat-select>
                </div>
              </td>
              <!-- other values -->
              <td *ngIf="df.dataType.toString() !== 'Html' &&
                          df.dataType.toString() !== 'Organization' &&
                          df.dataType.toString() !== 'TeamsMultiple' &&
                          df.dataType.toString() !== 'Team' &&
                          df.dataType.toString() !== 'DateTime' &&
                          df.dataType.toString() !== 'Status' &&
                          df.dataType.toString() !== 'User' &&
                          df.dataType.toString() !== 'Card' &&
                          df.dataType.toString() !== 'Move' &&
                          df.dataType.toString() !== 'Checkbox' &&
                          !df.isChosenFromList">
                <div class="constrainer" [style]="getStyle(df)">
                  {{ getScenarioEventValue(item, df.name) }}
                </div>
              </td>
            </ng-container>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>



</div>




